{% extends 'base.html' %}
{% load static %}

{% block title %}{{ book.title }} - Livros - Project Nix{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/book-reader-enhanced.css' %}">
{% endblock %}

{% block content %}
<div class="book-detail-container">
    <!-- Cabeçalho do livro -->
    <div class="book-header">
        {% if book.cover_image %}
        <div class="book-cover">
            <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="img-fluid">
        </div>
        {% endif %}
        
        <div class="book-info">
            <h1 class="book-title">{{ book.title }}</h1>
            
            <div class="book-meta">
                {% if book.author %}
                <div><i class="fas fa-user me-1"></i> {{ book.author }}</div>
                {% endif %}
                {% if book.published_date %}
                <div><i class="far fa-calendar-alt me-1"></i> {{ book.published_date|date:"d/m/Y" }}</div>
                {% endif %}
                {% if book.pages %}
                <div><i class="fas fa-file-alt me-1"></i> {{ book.pages }} páginas</div>
                {% endif %}
            </div>
            
            <div class="book-actions">
                <div class="action-buttons-row">
                    <a href="{% url 'books:book_list' %}" class="btn btn-outline-secondary btn-mobile">
                        <i class="fas fa-arrow-left me-1"></i>
                        <span class="btn-text">Voltar</span>
                    </a>
                    {% if user.is_authenticated %}
                    <button id="favorite-btn" class="btn btn-outline-warning btn-mobile">
                        <i id="favorite-icon" class="far fa-star me-1"></i>
                        <span id="favorite-label" class="btn-text">Favoritar</span>
                    </button>
                    {% endif %}
                    {% if user.is_staff %}
                    <a href="{% url 'books:book_edit' book.slug %}" class="btn btn-outline-primary btn-mobile">
                        <i class="fas fa-edit me-1"></i>
                        <span class="btn-text">Editar</span>
                    </a>
                    {% endif %}
                    {% if book.file %}
                    <a href="{{ book.file.url }}" class="btn btn-outline-success btn-mobile" download>
                        <i class="fas fa-download me-1"></i>
                        <span class="btn-text">Baixar</span>
                    </a>
                    {% endif %}
                </div>
                
                <!-- Sistema de tema unificado -->
                <div class="theme-controls-wrapper">
                    <div class="theme-controls" role="radiogroup" aria-label="Seleção de tema">
                        <button class="theme-option" data-theme="light" title="Tema claro" 
                                role="radio" aria-checked="true" tabindex="0">
                            <i class="fas fa-sun" aria-hidden="true"></i>
                            <span class="sr-only">Tema claro</span>
                        </button>
                        <button class="theme-option" data-theme="dark" title="Tema escuro" 
                                role="radio" aria-checked="false" tabindex="-1">
                            <i class="fas fa-moon" aria-hidden="true"></i>
                            <span class="sr-only">Tema escuro</span>
                        </button>
                        <button class="theme-option" data-theme="sepia" title="Tema sépia" 
                                role="radio" aria-checked="false" tabindex="-1">
                            <i class="fas fa-book-open" aria-hidden="true"></i>
                            <span class="sr-only">Tema sépia</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Descrição do livro -->
    {% if book.description %}
    <div class="book-description">
        <h3>Descrição</h3>
        <p>{{ book.description|linebreaks }}</p>
    </div>
    {% endif %}
    
    <!-- Leitor de livros (ÚNICA INSTÂNCIA) -->
    {% if book.file %}
    <div class="book-reader-container" id="book-reader-container">
        <div class="book-reader-header">
            <h2 class="book-reader-title">Leitor</h2>
            <div class="book-reader-controls">
                <button class="btn-reader" id="fullscreen-toggle" title="Alternar tela cheia">
                    <i class="fas fa-expand"></i>
                    <span>Tela cheia</span>
                </button>
            </div>
        </div>
        
        <div class="book-reader-content" id="book-reader-content">
            {% if is_epub %}
                <div id="epub-reader"></div>
            {% elif is_pdf %}
                <div class="pdf-container">
                    <embed id="pdf-viewer" src="{{ book.file.url }}" type="application/pdf">
                </div>
            {% else %}
                <div class="unsupported-format">
                    <i class="fas fa-exclamation-triangle fa-3x"></i>
                    <h4>Formato não suportado</h4>
                    <p>Este formato de arquivo não suporta visualização online.</p>
                    <a href="{{ book.file.url }}" class="btn btn-primary mt-2" download>
                        <i class="fas fa-download me-1"></i> Baixar arquivo
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-circle me-2"></i> Nenhum arquivo disponível para visualização.
    </div>
    {% endif %}
</div>

<!-- Scripts para o leitor -->
{% if book.file and is_epub %}
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
<script src="{% static 'js/epub-viewer.js' %}"></script>
{% endif %}

<script>
// ===== INTEGRAÇÃO COM SISTEMA GLOBAL DE TEMAS =====
// Usar o ThemeManager global se disponível, caso contrário usar implementação local
if (typeof window.ThemeManager !== 'undefined') {
    // Usar o sistema global
    document.addEventListener('DOMContentLoaded', () => {
        if (window.ThemeManager.init) {
            window.ThemeManager.init();
        }
    });
} else {
    // Fallback para implementação local simplificada
    class LocalThemeManager {
        constructor() {
            this.currentTheme = localStorage.getItem('theme') || 'light';
            this.init();
        }
        
        init() {
            this.applyTheme(this.currentTheme);
            this.setupThemeButtons();
        }
        
        applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            this.currentTheme = theme;
            localStorage.setItem('theme', theme);
            this.updateActiveButton();
        }
        
        setupThemeButtons() {
            const themeButtons = document.querySelectorAll('.theme-option');
            themeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const theme = button.getAttribute('data-theme');
                    this.applyTheme(theme);
                });
                
                // Navegação por teclado
                button.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        button.click();
                    }
                });
            });
        }
        
        updateActiveButton() {
            const themeButtons = document.querySelectorAll('.theme-option');
            themeButtons.forEach(button => {
                const theme = button.getAttribute('data-theme');
                const isActive = theme === this.currentTheme;
                
                button.classList.toggle('active', isActive);
                button.setAttribute('aria-checked', isActive.toString());
                button.tabIndex = isActive ? 0 : -1;
            });
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        new LocalThemeManager();
    });
}

// ===== GERENCIADOR DE PDF =====
class PDFManager {
    constructor() {
        this.pdfViewer = document.getElementById('pdf-viewer');
        this.init();
    }
    
    init() {
        if (this.pdfViewer) {
            this.optimizePDFDisplay();
            this.setupResizeHandler();
        }
    }
    
    optimizePDFDisplay() {
        this.pdfViewer.style.width = '100%';
        this.pdfViewer.style.height = '100%';
        this.pdfViewer.style.border = 'none';
    }
    
    setupResizeHandler() {
        window.addEventListener('resize', () => {
            this.optimizePDFDisplay();
        });
    }
}

// ===== GERENCIADOR DE TELA CHEIA =====
class FullscreenManager {
    constructor() {
        this.container = document.getElementById('book-reader-container');
        this.toggleBtn = document.getElementById('fullscreen-toggle');
        this.init();
    }
    
    init() {
        if (this.toggleBtn && this.container) {
            this.setupEventListeners();
            this.updateButton();
        }
    }
    
    setupEventListeners() {
        this.toggleBtn.addEventListener('click', () => this.toggle());
        
        const events = [
            'fullscreenchange',
            'webkitfullscreenchange',
            'mozfullscreenchange',
            'MSFullscreenChange'
        ];
        
        events.forEach(event => {
            document.addEventListener(event, () => this.updateButton());
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F11') {
                e.preventDefault();
                this.toggle();
            }
        });
    }
    
    toggle() {
        if (this.isFullscreen()) {
            this.exit();
        } else {
            this.enter();
        }
    }
    
    enter() {
        const element = this.container;
        
        if (element.requestFullscreen) {
            element.requestFullscreen().catch(console.error);
        } else if (element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen();
        } else if (element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
        } else if (element.msRequestFullscreen) {
            element.msRequestFullscreen();
        }
    }
    
    exit() {
        if (document.exitFullscreen) {
            document.exitFullscreen().catch(console.error);
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
    }
    
    isFullscreen() {
        return !!(document.fullscreenElement ||
                 document.webkitFullscreenElement ||
                 document.mozFullScreenElement ||
                 document.msFullscreenElement);
    }
    
    updateButton() {
        if (!this.toggleBtn) return;
        
        const icon = this.toggleBtn.querySelector('i');
        const span = this.toggleBtn.querySelector('span');
        
        if (this.isFullscreen()) {
            document.body.classList.add('reader-fullscreen');
            if (icon) {
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
            }
            if (span) span.textContent = 'Sair';
        } else {
            document.body.classList.remove('reader-fullscreen');
            if (icon) {
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
            }
            if (span) span.textContent = 'Tela cheia';
        }
    }
}

// ===== GERENCIADOR DE FAVORITOS =====
class FavoriteManager {
    constructor() {
        this.btn = document.getElementById('favorite-btn');
        this.icon = document.getElementById('favorite-icon');
        this.label = document.getElementById('favorite-label');
        this.slug = "{{ book.slug|escapejs }}";
        this.init();
    }
    
    init() {
        if (this.btn) {
            this.loadStatus();
            this.setupEventListener();
        }
    }
    
    async loadStatus() {
        try {
            const response = await fetch(`/livros/${this.slug}/favorite/status/`, {
                credentials: 'same-origin'
            });
            const data = await response.json();
            this.updateUI(data.favorite);
        } catch (error) {
            console.error('Erro ao verificar favorito:', error);
        }
    }
    
    setupEventListener() {
        this.btn.addEventListener('click', () => this.toggle());
    }
    
    async toggle() {
        const isActive = this.btn.classList.contains('active');
        const action = isActive ? 'unfavorite' : 'favorite';
        
        try {
            const response = await fetch(`/livros/${this.slug}/${action}/`, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': this.getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                this.updateUI(!isActive);
            }
        } catch (error) {
            console.error('Erro ao atualizar favorito:', error);
        }
    }
    
    updateUI(isFavorite) {
        if (isFavorite) {
            this.icon.classList.remove('far');
            this.icon.classList.add('fas');
            this.label.textContent = 'Favorito';
            this.btn.classList.add('active');
        } else {
            this.icon.classList.remove('fas');
            this.icon.classList.add('far');
            this.label.textContent = 'Favoritar';
            this.btn.classList.remove('active');
        }
    }
    
    getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
}

// ===== INICIALIZAÇÃO =====
class BookReaderApp {
    constructor() {
        this.managers = {};
        this.init();
    }
    
    init() {
        this.managers.pdf = new PDFManager();
        this.managers.fullscreen = new FullscreenManager();
        
        {% if user.is_authenticated %}
        this.managers.favorite = new FavoriteManager();
        {% endif %}
        
        this.initializeEpubViewer();
        
        document.querySelector('.book-detail-container')?.classList.add('fade-in');
    }
    
    initializeEpubViewer() {
        {% if book.file and is_epub %}
        const isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %};
        
        if (window.initEpubViewer) {
            window.initEpubViewer(
                "{{ book.file.url|escapejs }}",
                "{{ book.slug|escapejs }}",
                isAuthenticated,
                false
            );
        }
        {% endif %}
    }
    
    cleanup() {
        Object.values(this.managers).forEach(manager => {
            if (manager.cleanup) {
                manager.cleanup();
            }
        });
    }
}

// Inicializar aplicação
let bookReaderApp;

document.addEventListener('DOMContentLoaded', () => {
    bookReaderApp = new BookReaderApp();
});

window.addEventListener('beforeunload', () => {
    if (bookReaderApp) {
        bookReaderApp.cleanup();
    }
});
</script>
{% endblock %}