{% extends 'config/base_config.html' %}
{% load crispy_forms_tags %}
{% load config_extras %}

{% block title %}Informações do Banco de Dados - {{ block.super }}{% endblock %}

{% block config_title %}Informações do Banco de Dados{% endblock %}

{% block config_content %}
<!-- Cabeçalho da Página -->
<div class="config-page-header">
    <div class="config-page-title-section">
        <h1 class="config-page-title">
            <i class="fas fa-database config-page-icon" aria-hidden="true"></i>
            Informações do Banco de Dados
        </h1>
        <p class="config-page-subtitle">Status e configurações atuais do banco de dados</p>
    </div>
    <div class="config-page-actions">
        <button type="button" class="config-btn config-btn-outline" onclick="testConnection()">
            <i class="fas fa-vial" aria-hidden="true"></i>
            <span>Testar Conexão</span>
        </button>
        <button type="button" class="config-btn config-btn-outline" onclick="location.reload()">
            <i class="fas fa-sync" aria-hidden="true"></i>
            <span>Atualizar</span>
        </button>
    </div>
</div>

<!-- Status da Conexão -->
<div class="config-content-card">
    <div class="config-content-header">
        <h5 class="config-content-title">
            <i class="fas fa-plug" aria-hidden="true"></i>
            Status da Conexão
        </h5>
    </div>
    <div class="config-content-body">
        {% if connection_status.status == 'success' %}
            <div class="alert alert-success" role="alert">
                <i class="fas fa-check-circle" aria-hidden="true"></i>
                <strong>Conexão Ativa!</strong> {{ connection_status.message }}
            </div>
            
            {% if connection_status.details.version %}
                <div class="config-info-item">
                    <span class="config-info-label">Versão:</span>
                    <span class="config-info-value">{{ connection_status.details.version }}</span>
                </div>
            {% endif %}
            
            {% if connection_status.details.file_exists %}
                <div class="config-info-item">
                    <span class="config-info-label">Arquivo:</span>
                    <span class="config-info-value">Existe ({{ connection_status.details.file_size|filesizeformat }})</span>
                </div>
            {% endif %}
            
        {% else %}
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                <strong>Erro de Conexão!</strong> {{ connection_status.message }}
            </div>
        {% endif %}
    </div>
</div>

<!-- Grid de Informações -->
<div class="config-grid config-grid-2">
    <!-- Configuração Atual -->
    <div class="config-content-card">
        <div class="config-content-header">
            <h5 class="config-content-title">
                <i class="fas fa-info-circle" aria-hidden="true"></i>
                Configuração Atual
            </h5>
        </div>
        <div class="config-content-body">
            {% if db_info.error %}
                <div class="config-alert config-alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                    {{ db_info.error }}
                </div>
            {% else %}
                <div class="config-info-list">
                    <div class="config-info-item">
                        <span class="config-info-label">Tipo:</span>
                        <span class="config-info-value">
                            {% if db_info.is_sqlite %}
                                <span class="config-badge config-badge-primary">SQLite</span>
                            {% elif db_info.is_postgresql %}
                                <span class="config-badge config-badge-info">PostgreSQL</span>
                            {% elif db_info.is_mysql %}
                                <span class="config-badge config-badge-warning">MySQL</span>
                            {% else %}
                                <span class="config-badge config-badge-secondary">{{ db_info.type }}</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="config-info-item">
                        <span class="config-info-label">Engine:</span>
                        <span class="config-info-value"><code>{{ db_info.engine }}</code></span>
                    </div>
                    <div class="config-info-item">
                        <span class="config-info-label">Nome:</span>
                        <span class="config-info-value">{{ db_info.name }}</span>
                    </div>
                    {% if db_info.host %}
                    <div class="config-info-item">
                        <span class="config-info-label">Host:</span>
                        <span class="config-info-value">{{ db_info.host }}</span>
                    </div>
                    {% endif %}
                    {% if db_info.port %}
                    <div class="config-info-item">
                        <span class="config-info-label">Porta:</span>
                        <span class="config-info-value">{{ db_info.port }}</span>
                    </div>
                    {% endif %}
                    {% if db_info.user %}
                    <div class="config-info-item">
                        <span class="config-info-label">Usuário:</span>
                        <span class="config-info-value">{{ db_info.user }}</span>
                    </div>
                    {% endif %}
                    {% if db_info.file_path %}
                    <div class="config-info-item">
                        <span class="config-info-label">Arquivo:</span>
                        <span class="config-info-value"><code>{{ db_info.file_path }}</code></span>
                    </div>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Arquivo .env -->
    <div class="config-content-card">
        <div class="config-content-header">
            <h5 class="config-content-title">
                <i class="fas fa-file-code" aria-hidden="true"></i>
                Arquivo .env
            </h5>
        </div>
        <div class="config-content-body">
            {% if env_info.exists %}
                <div class="config-alert config-alert-success" role="alert">
                    <i class="fas fa-check-circle" aria-hidden="true"></i>
                    Arquivo .env encontrado
                </div>
                
                    <div class="config-info-item">
                        <span class="config-info-label">DATABASE_URL:</span>
                        <span class="config-info-value">
                            {% if env_info.has_database_url %}
                                <span class="config-badge config-badge-success">Configurado</span>
                            {% else %}
                                <span class="config-badge config-badge-warning">Não configurado</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="config-info-item">
                        <span class="config-info-label">DB_ENGINE:</span>
                        <span class="config-info-value">
                            {% if env_info.has_db_engine %}
                                <span class="config-badge config-badge-success">Configurado</span>
                            {% else %}
                                <span class="config-badge config-badge-warning">Não configurado</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                {% if env_info.variables %}
                <details class="config-details">
                    <summary class="config-details-summary">Ver todas as variáveis de banco</summary>
                    <div class="config-details-content">
                        {% for key, value in env_info.variables.items %}
                        <div class="config-code-line">
                            <code>{{ key }}={{ value }}</code>
                        </div>
                        {% endfor %}
                    </div>
                </details>
                {% endif %}
                
            {% else %}
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
                    {{ env_info.message }}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Aviso sobre Configuração -->
<div class="config-content-card">
    <div class="config-content-body">
        <div class="alert alert-info" role="alert">
            <i class="fas fa-info-circle" aria-hidden="true"></i>
            <strong>Configuração de Banco de Dados</strong><br>
            A configuração do banco de dados é feita apenas uma vez durante o setup inicial do sistema. 
            Para alterar a configuração, use o <a href="{% url 'config:setup_wizard' %}" class="alert-link">Wizard de Setup</a>.
        </div>
    </div>
</div>

<!-- Configurações de Banco de Dados -->
<div class="config-content-card">
    <div class="config-content-header">
        <h5 class="config-content-title">
            <i class="fas fa-database" aria-hidden="true"></i>
            Configurações de Banco de Dados
        </h5>
    </div>
    <div class="config-content-body">
        {% with headers=[
            {'label': 'Nome'},
            {'label': 'Engine'},
            {'label': 'Banco'},
            {'label': 'Status'}
        ] %}
        {% with rows=db_configs|map:'db_config_row' %}
            {% include 'config/includes/_table.html' with headers=headers rows=rows caption='Tabela de configurações de banco de dados' %}
        {% endwith %}
        {% endwith %}
    </div>
</div>

<script>
function testConnection() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testando...';
    button.disabled = true;
    
    fetch('{% url "config:database_connection_test" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showAlert('success', 'Conexão bem-sucedida!', data.message);
        } else {
            showAlert('danger', 'Erro na conexão!', data.message);
        }
    })
    .catch(error => {
        showAlert('danger', 'Erro no teste!', 'Erro ao executar o teste de conexão.');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function showAlert(type, title, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <strong>${title}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>

{% csrf_token %}
{% endblock %}