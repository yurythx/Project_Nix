{% extends 'config/base_config.html' %}

{% block config_title %}Templates de Email{% endblock %}

{% block config_content %}
<!-- Cabeçalho da Página -->
<div class="config-page-header">
    <div class="config-page-title-section">
        <h1 class="config-page-title">
            <i class="fas fa-file-alt config-page-icon" aria-hidden="true"></i>
            Templates de Email
        </h1>
    </div>
    <div class="config-page-actions">
        <button type="button" class="config-btn config-btn-primary" onclick="createTemplate()">
            <i class="fas fa-plus" aria-hidden="true"></i>
            <span>Novo Template</span>
        </button>
    </div>
</div>

<!-- Lista de Templates -->
<div class="config-content-card">
    <div class="config-content-header">
        <h5 class="config-content-title">
            <i class="fas fa-list" aria-hidden="true"></i>
            Templates Disponíveis
        </h5>
    </div>
    <div class="config-content-body">
        <!-- Tabela Desktop -->
        <div class="config-table-responsive config-table-desktop">
            <table class="config-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Arquivo</th>
                        <th>Descrição</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for template in email_templates %}
                    <tr>
                        <td class="config-table-name">
                            <strong>{{ template.name }}</strong>
                        </td>
                        <td>
                            <code class="config-table-code">{{ template.file }}</code>
                        </td>
                        <td class="config-table-description">
                            {{ template.description }}
                        </td>
                        <td>
                            <span class="config-badge {% if template.status == 'Ativo' %}config-badge-success{% else %}config-badge-secondary{% endif %}">
                                {{ template.status }}
                            </span>
                        </td>
                        <td>
                            <div class="config-table-actions">
                                <button type="button" 
                                        class="config-btn config-btn-sm config-btn-primary" 
                                        onclick="previewTemplate('{{ template.file }}')" 
                                        title="Visualizar">
                                    <i class="fas fa-eye" aria-hidden="true"></i>
                                </button>
                                <button type="button" 
                                        class="config-btn config-btn-sm config-btn-secondary" 
                                        onclick="editTemplate('{{ template.file }}')" 
                                        title="Editar">
                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                </button>
                                <button type="button" 
                                        class="config-btn config-btn-sm config-btn-info" 
                                        onclick="testTemplate('{{ template.file }}')" 
                                        title="Testar">
                                    <i class="fas fa-paper-plane" aria-hidden="true"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="config-table-empty">
                            <i class="fas fa-inbox" aria-hidden="true"></i>
                            Nenhum template de email encontrado
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Cards Mobile -->
        <div class="config-mobile-cards config-table-mobile">
            {% for template in email_templates %}
            <div class="config-mobile-card">
                <div class="config-mobile-card-header">
                    <h6 class="config-mobile-card-title">
                        <i class="fas fa-file-alt" aria-hidden="true"></i>
                        {{ template.name }}
                    </h6>
                    <span class="config-badge {% if template.status == 'Ativo' %}config-badge-success{% else %}config-badge-secondary{% endif %}">
                        {{ template.status }}
                    </span>
                </div>
                <div class="config-mobile-card-body">
                    <div class="config-mobile-card-info">
                        <div class="config-mobile-card-item">
                            <span class="config-mobile-card-label">Arquivo:</span>
                            <code class="config-mobile-card-value">{{ template.file }}</code>
                        </div>
                        <div class="config-mobile-card-item">
                            <span class="config-mobile-card-label">Descrição:</span>
                            <span class="config-mobile-card-value">{{ template.description }}</span>
                        </div>
                    </div>
                </div>
                <div class="config-mobile-card-actions">
                    <button type="button" 
                            class="config-btn config-btn-sm config-btn-primary" 
                            onclick="previewTemplate('{{ template.file }}')">
                        <i class="fas fa-eye" aria-hidden="true"></i>
                        Visualizar
                    </button>
                    <button type="button" 
                            class="config-btn config-btn-sm config-btn-secondary" 
                            onclick="editTemplate('{{ template.file }}')">
                        <i class="fas fa-edit" aria-hidden="true"></i>
                        Editar
                    </button>
                    <button type="button" 
                            class="config-btn config-btn-sm config-btn-info" 
                            onclick="testTemplate('{{ template.file }}')">
                        <i class="fas fa-paper-plane" aria-hidden="true"></i>
                        Testar
                    </button>
                </div>
            </div>
            {% empty %}
            <div class="config-empty-state">
                <i class="fas fa-inbox config-empty-icon" aria-hidden="true"></i>
                <h6 class="config-empty-title">Nenhum template encontrado</h6>
                <p class="config-empty-text">Clique em "Novo Template" para criar seu primeiro template de email.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Informações Auxiliares -->
<div class="config-grid-2">
    <!-- Variáveis Disponíveis -->
    <div class="config-content-card">
        <div class="config-content-header">
            <h5 class="config-content-title">
                <i class="fas fa-code" aria-hidden="true"></i>
                Variáveis Disponíveis
            </h5>
        </div>
        <div class="config-content-body">
            <div class="config-variables-section">
                <h6 class="config-variables-title">Usuário:</h6>
                <ul class="config-variables-list">
                    <li><code>{{ "{{ user.username }}" }}</code> - Nome de usuário</li>
                    <li><code>{{ "{{ user.email }}" }}</code> - Email do usuário</li>
                    <li><code>{{ "{{ user.first_name }}" }}</code> - Primeiro nome</li>
                    <li><code>{{ "{{ user.last_name }}" }}</code> - Último nome</li>
                    <li><code>{{ "{{ user.get_full_name }}" }}</code> - Nome completo</li>
                </ul>
                
                <h6 class="config-variables-title">Sistema:</h6>
                <ul class="config-variables-list">
                    <li><code>{{ "{{ site_name }}" }}</code> - Nome do site</li>
                    <li><code>{{ "{{ site_url }}" }}</code> - URL do site</li>
                    <li><code>{{ "{{ current_year }}" }}</code> - Ano atual</li>
                    <li><code>{{ "{{ support_email }}" }}</code> - Email de suporte</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Guia de Estilo -->
    <div class="config-content-card">
        <div class="config-content-header">
            <h5 class="config-content-title">
                <i class="fas fa-palette" aria-hidden="true"></i>
                Guia de Estilo
            </h5>
        </div>
        <div class="config-content-body">
            <div class="config-style-guide">
                <h6 class="config-variables-title">Cores do Sistema:</h6>
                <div class="config-color-palette">
                    <div class="config-color-item">
                        <div class="config-color-swatch" style="background-color: var(--nix-primary);"></div>
                        <span>Primária</span>
                    </div>
                    <div class="config-color-item">
                        <div class="config-color-swatch" style="background-color: var(--nix-success);"></div>
                        <span>Sucesso</span>
                    </div>
                    <div class="config-color-item">
                        <div class="config-color-swatch" style="background-color: var(--nix-warning);"></div>
                        <span>Aviso</span>
                    </div>
                    <div class="config-color-item">
                        <div class="config-color-swatch" style="background-color: var(--nix-danger);"></div>
                        <span>Erro</span>
                    </div>
                </div>
                
                <h6 class="config-variables-title">Fontes:</h6>
                <ul class="config-variables-list">
                    <li>Títulos: var(--font-family-heading)</li>
                    <li>Texto: var(--font-family-body)</li>
                    <li>Código: var(--font-family-mono)</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Preview -->
<div class="config-modal config-modal-fade" id="previewModal" tabindex="-1">
    <div class="config-modal-dialog config-modal-lg">
        <div class="config-modal-content">
            <div class="config-modal-header">
                <h5 class="config-modal-title">
                    <i class="fas fa-eye config-icon"></i>Preview do Template
                </h5>
                <button type="button" class="config-modal-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="config-modal-body">
                <div id="templatePreview">
                    <div class="config-text-center config-py-4">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="config-mt-2">Carregando preview...</p>
                    </div>
                </div>
            </div>
            <div class="config-modal-footer">
                <button type="button" class="config-btn config-btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="config-btn config-btn-primary" onclick="editCurrentTemplate()">
                    <i class="fas fa-edit config-icon"></i>Editar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Teste -->
<div class="config-modal config-modal-fade" id="testModal" tabindex="-1">
    <div class="config-modal-dialog">
        <div class="config-modal-content">
            <div class="config-modal-header">
                <h5 class="config-modal-title">
                    <i class="fas fa-paper-plane config-icon"></i>Testar Template
                </h5>
                <button type="button" class="config-modal-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="config-modal-body">
                <form id="testTemplateForm">
                    <div class="config-form-group">
                        <label for="testEmail" class="config-form-label">Email de Teste</label>
                        <input type="email" class="config-form-control" id="testEmail" 
                               value="{{ user.email }}" required>
                    </div>
                    <div class="config-form-group">
                        <label for="testSubject" class="config-form-label">Assunto</label>
                        <input type="text" class="config-form-control" id="testSubject" 
                               value="Teste de Template - Havoc">
                    </div>
                    <input type="hidden" id="testTemplateFile">
                </form>
            </div>
            <div class="config-modal-footer">
                <button type="button" class="config-btn config-btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="config-btn config-btn-primary" onclick="sendTestTemplate()">
                    <i class="fas fa-paper-plane config-icon"></i>Enviar Teste
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentTemplate = '';

// Preview do template
function previewTemplate(templateFile) {
    currentTemplate = templateFile;
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    
    // Simular carregamento do template
    document.getElementById('templatePreview').innerHTML = `
        <div class="config-border config-rounded config-p-3" style="background: #f8f9fa;">
            <h4>Template: ${templateFile}</h4>
            <hr>
            <div class="email-preview" style="background: white; padding: 20px; border-radius: 5px;">
                <h2 style="color: #0d6efd;">Havoc - Sistema de Gerenciamento</h2>
                <p>Olá <strong>{{ user.get_full_name }}</strong>,</p>
                <p>Este é um exemplo de como o template <code>${templateFile}</code> será renderizado.</p>
                <div class="config-alert config-alert-info">
                    <strong>Nota:</strong> Este é apenas um preview. O conteúdo real depende do contexto de uso.
                </div>
                <hr>
                <small class="config-text-muted">
                    © ${new Date().getFullYear()} Havoc - Todos os direitos reservados<br>
                    Este email foi enviado automaticamente pelo sistema.
                </small>
            </div>
        </div>
    `;
    
    modal.show();
}

// Editar template
function editTemplate(templateFile) {
    // Implementar editor de template
    alert('Funcionalidade de edição será implementada em breve.\nTemplate: ' + templateFile);
}

function editCurrentTemplate() {
    if (currentTemplate) {
        editTemplate(currentTemplate);
    }
}

// Testar template
function testTemplate(templateFile) {
    document.getElementById('testTemplateFile').value = templateFile;
    const modal = new bootstrap.Modal(document.getElementById('testModal'));
    modal.show();
}

// Enviar teste do template
function sendTestTemplate() {
    const email = document.getElementById('testEmail').value;
    const subject = document.getElementById('testSubject').value;
    const templateFile = document.getElementById('testTemplateFile').value;
    
    if (!email) {
        alert('Por favor, informe um email para teste.');
        return;
    }
    
    // Simular envio
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin config-icon"></i>Enviando...';
    
    setTimeout(() => {
        button.disabled = false;
        button.innerHTML = originalText;
        
        // Fechar modal
        bootstrap.Modal.getInstance(document.getElementById('testModal')).hide();
        
        // Mostrar sucesso
        showAlert('success', `Template ${templateFile} enviado com sucesso para ${email}!`);
    }, 2000);
}

// Mostrar alerta
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `config-alert config-alert-${type} config-alert-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; position: fixed;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="config-alert-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}
