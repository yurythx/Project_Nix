{% extends 'config/base_config.html' %}

{% block config_title %}Restaurar Banco de Dados{% endblock %}

{% block config_content %}
<!-- Cabeçalho da Página -->
<div class="config-page-header">
    <div class="config-page-title-section">
        <h1 class="config-page-title">
            <i class="fas fa-database config-page-icon" aria-hidden="true"></i>
            Restaurar Banco de Dados
        </h1>
    </div>
</div>

<!-- Mensagens -->
{% if messages %}
    {% for message in messages %}
        <div class="config-alert config-alert-{{ message.tags }} config-alert-dismissible" role="alert">
            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% elif message.tags == 'warning' %}exclamation-triangle{% else %}info-circle{% endif %}" aria-hidden="true"></i>
            {{ message }}
            <button type="button" class="config-alert-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    {% endfor %}
{% endif %}

<!-- Formulário de Restauração -->
<div class="config-content-card">
    <div class="config-content-header">
        <h5 class="config-content-title">
            <i class="fas fa-upload" aria-hidden="true"></i>
            Upload do Arquivo de Backup
        </h5>
    </div>
    <div class="config-content-body">
        <div class="config-alert config-alert-danger">
            <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
            <strong>Atenção:</strong> Esta ação irá sobrescrever todos os dados atuais do banco de dados!
            Certifique-se de ter um backup atual antes de prosseguir.
        </div>
        
        <form method="post" enctype="multipart/form-data" id="restore-form" class="config-form">
            {% csrf_token %}
            <div class="config-form-group">
                <label for="id_backup_file" class="config-form-label">
                    <i class="fas fa-file-archive" aria-hidden="true"></i>
                    Arquivo de Backup
                </label>
                <input type="file" 
                       class="config-form-input" 
                       id="id_backup_file" 
                       name="backup_file" 
                       accept=".backup,.sql,.sqlite3" 
                       required>
                <div class="config-form-help">
                    Formatos aceitos: .backup, .sql, .sqlite3
                </div>
            </div>
            
            <div class="config-upload-progress" style="display: none;">
                <div class="config-progress-bar">
                    <div id="upload-progress-bar" class="config-progress-fill" style="width: 0%">
                        <span class="config-progress-text">0%</span>
                    </div>
                </div>
            </div>
            
            <div class="config-form-actions">
                <button type="submit" class="config-btn config-btn-danger">
                    <i class="fas fa-database" aria-hidden="true"></i>
                    <span>Restaurar Banco de Dados</span>
                </button>
                <a href="{% url 'config:backup_database' %}" class="config-btn config-btn-outline">
                    <i class="fas fa-arrow-left" aria-hidden="true"></i>
                    <span>Voltar para Backups</span>
                </a>
            </div>
        </form>
    </div>
</div>
<script>
document.getElementById('restore-form').addEventListener('submit', function(e) {
    var form = this;
    var fileInput = document.getElementById('id_backup_file');
    if (fileInput.files.length === 0) return;
    e.preventDefault();
    var progressBar = document.getElementById('upload-progress-bar');
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    progressBar.parentElement.style.display = '';
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '', true);
    xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
            var percent = Math.round((e.loaded / e.total) * 100);
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
        }
    };
    xhr.onload = function() {
        if (xhr.status === 200) {
            progressBar.classList.add('bg-success');
            progressBar.textContent = 'Concluído';
            setTimeout(function(){ location.reload(); }, 1500);
        } else {
            progressBar.classList.add('bg-danger');
            progressBar.textContent = 'Erro';
        }
    };
    var formData = new FormData(form);
    xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
    xhr.send(formData);
});
</script>
{% endblock %}