{% extends 'base.html' %}
{% load static %}

{% block title %}Gerenciar Cache - Project Nix{% endblock %}

{% block content %}
<div class="config-container">
    <div class="config-page-header">
        <div class="config-page-title">
            <i class="fas fa-database"></i>
            <div>
                <h1>Gerenciar Cache</h1>
                <p>Gerencie o cache do sistema de permissões</p>
            </div>
        </div>
    </div>

    <!-- Estatísticas do Cache -->
    <div class="config-grid">
        <div class="config-grid-half">
            <div class="config-content-card">
                <div class="config-content-header">
                    <div class="config-content-title">
                        <i class="fas fa-info-circle"></i>
                        Informações do Sistema
                    </div>
                </div>
                <div class="config-content-body">
                    <div class="config-info-grid">
                        <div class="config-info-column">
                            <div class="config-info-item">
                                <span class="config-info-label">Django Version:</span>
                                <span class="config-info-value">{{ system_info.django_version }}</span>
                            </div>
                            <div class="config-info-item">
                                <span class="config-info-label">Python Version:</span>
                                <span class="config-info-value">{{ system_info.python_version }}</span>
                            </div>
                        </div>
                        <div class="config-info-column">
                            <div class="config-info-item">
                                <span class="config-info-label">Cache Backend:</span>
                                <span class="config-info-value">{{ system_info.cache_backend }}</span>
                            </div>
                            <div class="config-info-item">
                                <span class="config-info-label">TTL Padrão:</span>
                                <span class="config-info-value">{{ cache_stats.default_ttl|default:300 }}s</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="config-grid-half">
            <div class="config-content-card">
                <div class="config-content-header">
                    <div class="config-content-title">
                        <i class="fas fa-chart-bar"></i>
                        Estatísticas do Cache
                    </div>
                </div>
                <div class="config-content-body">
                    <div class="config-info-grid">
                        <div class="config-info-column">
                            <div class="config-info-item">
                                <span class="config-info-label">Prefixos:</span>
                                <span class="config-info-value">{{ cache_stats.prefixes|length }}</span>
                            </div>
                            <div class="config-info-item">
                                <span class="config-info-label">Backend:</span>
                                <span class="config-info-value">{{ cache_stats.backend|default:"Unknown" }}</span>
                            </div>
                        </div>
                        <div class="config-info-column">
                            <div class="config-info-item">
                                <span class="config-info-label">Status:</span>
                                <span class="config-info-value">
                                    {% if cache_stats.error %}
                                        <span class="config-badge config-badge-danger">Erro</span>
                                    {% else %}
                                        <span class="config-badge config-badge-success">OK</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ações de Cache -->
    <div class="config-content-card">
        <div class="config-content-header">
            <div class="config-content-title">
                <i class="fas fa-tools"></i>
                Ações de Cache
            </div>
        </div>
        <div class="config-content-body">
            <div class="config-action-grid">
                <!-- Limpar Todo o Cache -->
                <div class="config-action-card config-action-warning">
                    <div class="config-action-content">
                        <i class="fas fa-trash-alt fa-2x config-text-warning mb-3"></i>
                        <h6>Limpar Todo o Cache</h6>
                        <p class="config-text-muted">Remove todos os dados do cache de permissões</p>
                        <form method="post" class="config-action-form">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="clear_all">
                            <button type="submit" class="config-btn config-btn-warning config-btn-sm" 
                                    onclick="return confirm('Tem certeza que deseja limpar todo o cache?')">
                                <i class="fas fa-trash"></i> Limpar Tudo
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Invalidar Cache de Usuário -->
                <div class="config-action-card config-action-info">
                    <div class="config-action-content">
                        <i class="fas fa-user-times fa-2x config-text-info mb-3"></i>
                        <h6>Invalidar Cache de Usuário</h6>
                        <p class="config-text-muted">Remove cache de um usuário específico</p>
                        <form method="post" class="config-action-form config-form-inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="invalidate_user">
                            <input type="number" name="user_id" class="config-form-control config-form-control-sm" 
                                   placeholder="ID do usuário" required>
                            <button type="submit" class="config-btn config-btn-info config-btn-sm">
                                <i class="fas fa-user-times"></i> Invalidar
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Invalidar Cache de Objeto -->
                <div class="config-action-card config-action-primary">
                    <div class="config-action-content">
                        <i class="fas fa-cube fa-2x config-text-primary mb-3"></i>
                        <h6>Invalidar Cache de Objeto</h6>
                        <p class="config-text-muted">Remove cache de um objeto específico</p>
                        <form method="post" class="config-action-form config-form-inline">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="invalidate_object">
                            <input type="text" name="model_name" class="config-form-control config-form-control-sm" 
                                   placeholder="Modelo (ex: manga)" required>
                            <input type="number" name="object_id" class="config-form-control config-form-control-sm" 
                                   placeholder="ID do objeto" required>
                            <button type="submit" class="config-btn config-btn-primary config-btn-sm">
                                <i class="fas fa-cube"></i> Invalidar
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Informações Detalhadas -->
    <div class="config-content-card">
        <div class="config-content-header">
            <div class="config-content-title">
                <i class="fas fa-list"></i>
                Detalhes do Cache
            </div>
        </div>
        <div class="config-content-body">
            {% if cache_stats.error %}
                <div class="config-alert config-alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Erro no Cache:</strong> {{ cache_stats.error }}
                </div>
            {% else %}
                <div class="config-table-responsive">
                    <table class="config-table">
                        <thead class="config-table-header">
                            <tr class="config-table-row">
                                <th class="config-table-cell">Propriedade</th>
                                <th class="config-table-cell">Valor</th>
                                <th class="config-table-cell">Descrição</th>
                            </tr>
                        </thead>
                        <tbody class="config-table-body">
                            <tr class="config-table-row">
                                <td class="config-table-cell"><strong>Backend</strong></td>
                                <td class="config-table-cell"><code>{{ cache_stats.backend|default:"Unknown" }}</code></td>
                                <td class="config-table-cell">Backend de cache configurado</td>
                            </tr>
                            <tr class="config-table-row">
                                <td class="config-table-cell"><strong>TTL Padrão</strong></td>
                                <td class="config-table-cell"><code>{{ cache_stats.default_ttl|default:300 }}s</code></td>
                                <td class="config-table-cell">Tempo de vida padrão das chaves</td>
                            </tr>
                            <tr class="config-table-row">
                                <td class="config-table-cell"><strong>Prefixos</strong></td>
                                <td class="config-table-cell"><code>{{ cache_stats.prefixes|length }}</code></td>
                                <td class="config-table-cell">Número de prefixos de cache</td>
                            </tr>
                            <tr class="config-table-row">
                                <td class="config-table-cell"><strong>Status</strong></td>
                                <td class="config-table-cell">
                                    {% if cache_stats.error %}
                                        <span class="config-badge config-badge-danger">Erro</span>
                                    {% else %}
                                        <span class="config-badge config-badge-success">Funcionando</span>
                                    {% endif %}
                                </td>
                                <td class="config-table-cell">Status atual do cache</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                {% if cache_stats.prefixes %}
                <div class="config-section-spacing">
                    <h6>Prefixos de Cache:</h6>
                    <div class="config-badge-grid">
                        {% for prefix in cache_stats.prefixes %}
                        <span class="config-badge config-badge-secondary">{{ prefix }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="config-modal" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="config-modal-dialog">
        <div class="config-modal-content">
            <div class="config-modal-header">
                <h5 class="config-modal-title" id="confirmModalLabel">Confirmar Ação</h5>
                <button type="button" class="config-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="config-modal-body">
                <p>Tem certeza que deseja executar esta ação?</p>
                <p class="config-text-muted">Esta ação pode afetar temporariamente a performance do sistema.</p>
            </div>
            <div class="config-modal-footer">
                <button type="button" class="config-btn config-btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="config-btn config-btn-primary" id="confirmAction">Confirmar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Confirmação para ações perigosas
document.addEventListener('DOMContentLoaded', function() {
    const dangerousActions = document.querySelectorAll('button[onclick*="confirm"]');
    
    dangerousActions.forEach(button => {
        button.addEventListener('click', function(e) {
            if (!confirm('Esta ação é irreversível. Tem certeza que deseja continuar?')) {
                e.preventDefault();
            }
        });
    });
});

// Auto-refresh das estatísticas a cada 30 segundos
setInterval(function() {
    // Aqui você pode adicionar AJAX para atualizar as estatísticas
    console.log('Atualizando estatísticas do cache...');
}, 30000);
</script>
{% endblock %}